generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "mysql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model User {
  id                    String               @id @default(cuid())
  name                  String?
  username              String?              @unique
  email                 String?              @unique
  emailVerified         DateTime?
  image                 String?
  password              String?
  role                  String               @default("FREE")
  subscriptionStatus    String               @default("TRIAL")
  trialEndsAt           DateTime?
  stripeCustomerId      String?              @unique
  stripeSubscriptionId  String?              @unique
  stripePriceId         String?
  stripeCurrentPeriodEnd DateTime?
  requirePasswordChange Boolean              @default(false)
  accountStatus         String               @default("ACTIVE")
  suspendedAt           DateTime?
  suspendedBy           String?
  suspensionReason      String?              @db.VarChar(500)
  suspensionExpiresAt   DateTime?
  twoFactorSecret       String?
  twoFactorEnabled      Boolean              @default(false)
  twoFactorBackupCodes  String?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  accounts              Account[]
  auditLogs             AuditLog[]
  passwordResetTokens   PasswordResetToken[]
  sessions              Session[]
  friendOf              Friendship[]         @relation("FriendOf")
  friendships           Friendship[]         @relation("UserFriendships")
  joinRequests          JoinRequest[]
  hostedRooms           MultiplayerRoom[]    @relation("HostedRooms")
  notifications         Notification[]
  invitesSent           RoomInvite[]         @relation("InvitesSent")
  invitesReceived       RoomInvite[]         @relation("InvitesReceived")
  userAchievements      UserAchievement[]
  userProgress          UserProgress[]
  hintUsageEvents       HintUsageEvent[]
  userStats             UserStats?
  emailVerifications    EmailVerification[]

  @@index([accountStatus])
  @@index([suspendedAt])
}

model FeatureFlag {
  id                String               @id @default(cuid())
  name              String               @unique
  description       String?
  enabled           Boolean              @default(false)
  rolloutPercentage Int                  @default(0)
  targetUsers       String?              @db.LongText
  targetRoles       String?              @db.LongText
  conditions        String?              @db.LongText
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  createdBy         String
  version           Int                  @default(1)
  history           FeatureFlagHistory[]

  @@index([enabled])
  @@index([createdBy])
}

model FeatureFlagHistory {
  id            String      @id @default(cuid())
  featureFlagId String
  action        String
  previousState String?     @db.LongText
  newState      String?     @db.LongText
  actorUserId   String
  createdAt     DateTime    @default(now())
  featureFlag   FeatureFlag @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)

  @@index([featureFlagId])
  @@index([actorUserId])
  @@index([createdAt])
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.LongText
  description String?
  category    String   @default("general")
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  updatedBy   String

  @@index([category])
  @@index([isPublic])
}

model ABTest {
  id             String         @id @default(cuid())
  name           String         @unique
  description    String
  status         String         @default("DRAFT")
  variants       String         @db.LongText
  targetAudience String         @db.LongText
  metrics        String         @db.LongText
  startDate      DateTime?
  endDate        DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  createdBy      String
  results        ABTestResult[]

  @@index([status])
  @@index([createdBy])
}

model ABTestResult {
  id               String   @id @default(cuid())
  testId           String
  userId           String
  variant          String
  assignedAt       DateTime @default(now())
  conversionEvents String   @default("[]") @db.LongText
  metrics          String   @default("{}") @db.LongText
  test             ABTest   @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId])
  @@index([userId])
  @@index([assignedAt])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId], map: "Account_userId_fkey")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "Session_userId_fkey")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "PasswordResetToken_userId_fkey")
}

model LoginAttempt {
  id        String   @id @default(cuid())
  email     String
  ip        String?
  success   Boolean
  createdAt DateTime @default(now())
}

model Puzzle {
  id                   Int                @id @default(autoincrement())
  title                String             @db.VarChar(255)
  description          String?            @db.Text
  filename             String             @db.VarChar(255)
  original_filename    String             @db.VarChar(255)
  file_path            String             @db.VarChar(500)
  tier                 String?            @db.VarChar(10)
  category             String?            @db.VarChar(100)
  difficulty           String?            @db.VarChar(10)
  uploaded_by          String?
  upload_date          DateTime?          @default(now())
  is_active            Boolean?           @default(true)
  play_count           Int?               @default(0)
  completion_rate      Decimal?           @default(0.00) @db.Decimal(5, 2)
  estimated_solve_time Int?               @default(15)
  avg_solve_time       Decimal?           @default(0.00) @db.Decimal(5, 2)
  best_score           Int?               @default(0)
  grid_width           Int?
  grid_height          Int?
  tags                 String?            @db.Text
  clues                String?            @db.LongText
  clueCache            PuzzleClueCache[]
  multiplayerRooms     MultiplayerRoom[]

  @@map("puzzles")
}

model UserProgress {
  id                    String    @id @default(cuid())
  userId                String
  puzzleId              Int
  completedCells        String?   @db.Text
  hintsUsed             Int       @default(0)
  isCompleted           Boolean   @default(false)
  lastPlayedAt          DateTime  @default(now())
  completedAt           DateTime?
  completionTimeSeconds Int?
  score                 Int       @default(0)
  startedAt             DateTime  @default(now())
  timesPlayed           Int       @default(1)
  bestTimeSeconds       Int?
  totalAccuracy         Float?    @default(100)
  autoSaveCount         Int       @default(0)
  lastAutoSave          DateTime?
  saveHistory           String?   @db.LongText
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, puzzleId])
  @@index([lastAutoSave])
  @@map("user_progress")
}

model HintUsageEvent {
  id        String   @id @default(cuid())
  userId    String?
  guestId   String?
  hintType  HintType
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, hintType, createdAt])
  @@index([guestId, hintType, createdAt])
  @@map("hint_usage_events")
}

model AuditLog {
  id          String   @id @default(cuid())
  actorUserId String
  action      String   @db.VarChar(100)
  entityType  String   @db.VarChar(50)
  entityId    String   @db.VarChar(100)
  before      String?  @db.Text
  after       String?  @db.Text
  ip          String?  @db.VarChar(64)
  createdAt   DateTime @default(now())
  actor       User     @relation(fields: [actorUserId], references: [id])

  @@index([actorUserId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model MultiplayerRoom {
  id              String             @id @default(cuid())
  roomCode        String             @unique @db.Char(6)
  name            String?            @db.VarChar(100)
  description     String?            @db.VarChar(200)
  puzzleId        Int
  hostUserId      String
  maxPlayers      Int                @default(4)
  isPrivate       Boolean            @default(false)
  password        String?            @db.VarChar(255)
  allowSpectators Boolean            @default(true)
  autoStart       Boolean            @default(false)
  timeLimit       Int?
  difficulty      String?            @db.VarChar(20)
  tags            String?            @db.Text
  status          RoomStatus         @default(WAITING)
  gridState       String?            @db.Text
  createdAt       DateTime           @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  expiresAt       DateTime?
  autoCleanup     Boolean            @default(true)
  isPersistent    Boolean            @default(true)
  lastActivityAt  DateTime           @default(now())
  persistenceDays Int                @default(7)
  lastSyncedAt    DateTime?
  autoSaveEnabled Boolean            @default(true)
  saveInterval    Int                @default(30000)
  joinRequests    JoinRequest[]
  hostUser        User               @relation("HostedRooms", fields: [hostUserId], references: [id])
  puzzle          Puzzle             @relation(fields: [puzzleId], references: [id])
  bannedUsers     RoomBannedUser[]
  invites         RoomInvite[]
  messages        RoomMessage[]
  mutedUsers      RoomMutedUser[]
  participants    RoomParticipant[]
  stateVersions   RoomStateVersion[]

  @@index([roomCode])
  @@index([status])
  @@index([hostUserId])
  @@index([createdAt])
  @@index([puzzleId], map: "multiplayer_rooms_puzzleId_fkey")
  @@map("multiplayer_rooms")
}

model RoomParticipant {
  id             String          @id @default(cuid())
  roomId         String
  userId         String
  role           ParticipantRole @default(PLAYER)
  displayName    String          @db.VarChar(100)
  avatarUrl      String?         @db.VarChar(255)
  cursorPosition String?         @db.VarChar(20)
  completedCells String?         @db.Text
  lastActiveAt   DateTime        @default(now())
  isOnline       Boolean         @default(true)
  joinedAt       DateTime        @default(now())
  leftAt         DateTime?
  room           MultiplayerRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@index([roomId])
  @@index([userId])
  @@index([lastActiveAt])
  @@map("room_participants")
}

model RoomMessage {
  id        String          @id @default(cuid())
  roomId    String
  userId    String
  userName  String          @db.VarChar(100)
  content   String          @db.VarChar(500)
  type      String          @default("text") @db.VarChar(20)
  metadata  String?         @db.Text
  createdAt DateTime        @default(now())
  isDeleted Boolean         @default(false)
  deletedBy String?         @db.VarChar(100)
  deletedAt DateTime?
  room      MultiplayerRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([createdAt])
  @@index([type])
  @@map("room_messages")
}

model RoomMutedUser {
  id              String          @id @default(cuid())
  roomId          String
  userId          String
  userName        String          @db.VarChar(100)
  mutedBy         String
  mutedByUserName String          @db.VarChar(100)
  mutedUntil      DateTime
  reason          String?         @db.VarChar(200)
  createdAt       DateTime        @default(now())
  room            MultiplayerRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([userId])
  @@index([mutedUntil])
  @@map("room_muted_users")
}

model RoomBannedUser {
  id               String          @id @default(cuid())
  roomId           String
  userId           String
  userName         String          @db.VarChar(100)
  bannedBy         String
  bannedByUserName String          @db.VarChar(100)
  bannedUntil      DateTime
  reason           String?         @db.VarChar(200)
  createdAt        DateTime        @default(now())
  room             MultiplayerRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([userId])
  @@index([bannedUntil])
  @@map("room_banned_users")
}

model RoomStateVersion {
  id        String          @id @default(cuid())
  roomId    String
  stateData String          @db.Text
  version   Int
  checksum  String          @db.VarChar(32)
  createdAt DateTime        @default(now())
  room      MultiplayerRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([createdAt])
  @@index([version])
  @@map("room_state_versions")
}

model Achievement {
  id               String              @id @default(cuid())
  key              String              @unique @db.VarChar(64)
  name             String              @db.VarChar(120)
  description      String?             @db.VarChar(300)
  category         AchievementCategory
  tier             AchievementTier     @default(BRONZE)
  points           Int                 @default(0)
  iconName         String              @db.VarChar(50)
  requirement      String              @db.Text
  isSecret         Boolean             @default(false)
  order            Int                 @default(0)
  createdAt        DateTime            @default(now())
  userAchievements UserAchievement[]

  @@index([category])
  @@index([tier])
  @@index([order])
  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  progress      Int         @default(0)
  earnedAt      DateTime?
  notified      Boolean     @default(false)
  createdAt     DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([earnedAt])
  @@index([achievementId], map: "user_achievements_achievementId_fkey")
  @@map("user_achievements")
}

model LeaderboardEntry {
  id          String            @id @default(cuid())
  period      LeaderboardPeriod
  scope       LeaderboardScope
  scopeId     String?           @db.VarChar(50)
  userId      String
  userName    String            @db.VarChar(100)
  userAvatar  String?           @db.VarChar(255)
  metric      String            @db.VarChar(50)
  value       Int
  rank        Int?
  periodStart DateTime
  periodEnd   DateTime
  computedAt  DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@unique([period, scope, scopeId, metric, userId])
  @@index([period, scope, metric, rank])
  @@index([userId])
  @@index([periodStart, periodEnd])
  @@map("leaderboard_entries")
}

model UserStats {
  id                    String    @id @default(cuid())
  userId                String    @unique
  totalPuzzlesStarted   Int       @default(0)
  totalPuzzlesCompleted Int       @default(0)
  totalPlayTime         Int       @default(0)
  averageAccuracy       Float     @default(100)
  averageCompletionTime Float     @default(0)
  currentStreak         Int       @default(0)
  longestStreak         Int       @default(0)
  lastPlayedDate        DateTime?
  totalScore            Int       @default(0)
  achievementPoints     Int       @default(0)
  globalRank            Int?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([globalRank])
  @@index([totalScore])
  @@map("user_stats")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String   @db.Text
  actionUrl String?
  metadata  String?  @db.LongText
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

model Friendship {
  id          String   @id @default(cuid())
  userId      String
  friendId    String
  status      String   @default("PENDING")
  initiatedBy String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  friend      User     @relation("FriendOf", fields: [friendId], references: [id], onDelete: Cascade)
  user        User     @relation("UserFriendships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
  @@index([friendId], map: "friendships_friendId_fkey")
  @@map("friendships")
}

model RoomInvite {
  id          String          @id @default(cuid())
  roomId      String
  invitedById String
  inviteeId   String
  status      String          @default("PENDING")
  message     String?         @db.Text
  expiresAt   DateTime
  createdAt   DateTime        @default(now())
  invitedBy   User            @relation("InvitesSent", fields: [invitedById], references: [id], onDelete: Cascade)
  invitee     User            @relation("InvitesReceived", fields: [inviteeId], references: [id], onDelete: Cascade)
  room        MultiplayerRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([roomId, inviteeId])
  @@index([invitedById], map: "room_invites_invitedById_fkey")
  @@index([inviteeId], map: "room_invites_inviteeId_fkey")
  @@map("room_invites")
}

model JoinRequest {
  id        String          @id @default(cuid())
  roomId    String
  userId    String
  message   String?         @db.Text
  status    String          @default("PENDING")
  createdAt DateTime        @default(now())
  room      MultiplayerRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@index([userId], map: "join_requests_userId_fkey")
  @@map("join_requests")
}

model PuzzleClueCache {
  id          String    @id @default(cuid())
  puzzleId    Int
  fileHash    String    @db.VarChar(64)
  version     Int       @default(1)
  acrossClues String    @db.LongText
  downClues   String    @db.LongText
  metadata    String?   @db.LongText
  sourceType  String    @default("iframe") @db.VarChar(20)
  parseTimeMs Int?
  isValid     Boolean   @default(true)
  validatedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  puzzle      Puzzle    @relation(fields: [puzzleId], references: [id], onDelete: Cascade)

  @@unique([puzzleId, fileHash])
  @@index([puzzleId])
  @@index([fileHash])
  @@index([isValid])
  @@index([createdAt])
  @@map("puzzle_clue_cache")
}

model ClueCacheStats {
  id             String   @id @default(cuid())
  date           DateTime @unique @db.Date
  cacheHits      Int      @default(0)
  cacheMisses    Int      @default(0)
  iframeParses   Int      @default(0)
  avgParseTimeMs Decimal? @db.Decimal(10, 2)
  totalRefreshes Int      @default(0)
  errors         Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([date])
  @@map("clue_cache_stats")
}

model ClueParseLog {
  id           String   @id @default(cuid())
  puzzleId     Int
  action       String   @db.VarChar(50)
  source       String   @db.VarChar(20)
  success      Boolean
  durationMs   Int?
  errorMessage String?  @db.Text
  metadata     String?  @db.LongText
  createdAt    DateTime @default(now())

  @@index([puzzleId])
  @@index([action])
  @@index([createdAt])
  @@index([success])
  @@map("clue_parse_log")
}

model WaitlistEntry {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())
}

model EmailLog {
  id             String    @id @default(cuid())
  messageId      String    @unique
  recipient      String
  subject        String
  template       String
  status         String
  sentAt         DateTime  @default(now())
  openedAt       DateTime?
  clickedAt      DateTime?
  bouncedAt      DateTime?
  bounceType     String?
  bounceReason   String?   @db.Text
  unsubscribedAt DateTime?
  userAgent      String?   @db.Text
  ipAddress      String?
  
  @@index([recipient])
  @@index([status])
  @@index([template])
  @@index([sentAt])
  @@map("email_logs")
}

model EmailEngagement {
  id        String   @id @default(cuid())
  messageId String
  eventType String
  timestamp DateTime @default(now())
  url       String?  @db.Text
  userAgent String?  @db.Text
  ipAddress String?
  details   Json?
  
  @@index([messageId])
  @@index([eventType])
  @@index([timestamp])
  @@map("email_engagements")
}

model EmailSecurityLog {
  id        String   @id @default(cuid())
  eventType String
  recipient String
  details   Json?
  timestamp DateTime @default(now())
  
  @@index([recipient])
  @@index([eventType])
  @@index([timestamp])
  @@map("email_security_logs")
}

model EmailVerification {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  email     String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([email])
  @@map("email_verifications")
}

enum RoomStatus {
  WAITING
  ACTIVE
  COMPLETED
  EXPIRED
}

enum ParticipantRole {
  HOST
  PLAYER
  SPECTATOR
}

enum AchievementCategory {
  COMPLETION
  SPEED
  STREAK
  ACCURACY
  SOCIAL
  MASTERY
  SPECIAL
}

enum AchievementTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

enum LeaderboardPeriod {
  DAILY
  WEEKLY
  MONTHLY
  ALL_TIME
}

enum LeaderboardScope {
  GLOBAL
  PUZZLE
  DIFFICULTY
}

enum HintType {
  letter
  word
}
